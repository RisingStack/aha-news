---
import FlashAlert from "../../../components/FlashAlert.astro";
import { z } from "astro:content";
import { createUser } from "../../../contexts/User";
import { capitalizeFirstLetter } from "../../../helpers";

export const partial = true;
let formObject, error;

const formObjectSchema = z.object({
  email: z.string().email(),
  name: z.string(),
  password: z.string().min(6),
});

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  try {
    formObject = formObjectSchema.parse({
      email: formData.get("email"),
      name: formData.get("name"),
      password: formData.get("password"),
    });
  } catch (error) {
    return new Response(JSON.stringify(error.format()), {
      status: 400,
    });
  }

  try {
    await createUser(formObject);
    return new Response(null, {
      status: 200,
      headers: {
        "HX-Redirect": "/signin",
      },
    });
  } catch (err) {
    switch (err.code) {
      case "P2002":
        const targets = err.meta.target.map(capitalizeFirstLetter).join(", ");
        error = `${targets} already exists`;
        break;
      default:
        error = "An error occurred";
    }
  }
}
---

<FlashAlert message={error} shown hxSwapOob />
